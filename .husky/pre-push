#!/bin/sh

echo "üîç Running pre-push checks..."
echo ""

# Track failed checks
failed_checks=""

echo "üìù Type checking..."
if npm run typecheck > /dev/null 2>&1; then
  echo "‚úÖ Type check passed"
else
  echo "‚ùå Type check failed"
  failed_checks="$failed_checks typecheck"
fi
echo ""

echo "üé® Linting (strict mode)..."
if npm run lint > /dev/null 2>&1; then
  echo "‚úÖ Lint passed (no warnings)"
else
  echo "‚ùå Lint failed"
  failed_checks="$failed_checks lint"
fi
echo ""

echo "üß™ Running tests (strict mode)..."
if npm run test:ci > /dev/null 2>&1; then
  echo "‚úÖ Tests passed (no warnings)"
else
  echo "‚ùå Tests failed"
  failed_checks="$failed_checks tests"
fi
echo ""

echo "üîí Security audit (high/critical vulnerabilities)..."
if npm audit --audit-level=high > /dev/null 2>&1; then
  echo "‚úÖ Security audit passed"
else
  echo "‚ùå Security audit failed (high or critical vulnerabilities detected)"
  failed_checks="$failed_checks audit"
fi
echo ""

# Check if any checks failed
if [ -n "$failed_checks" ]; then
  echo "‚ùå Pre-push checks failed:$failed_checks"
  echo ""
  echo "Run the failed commands to see details:"
  for check in $failed_checks; do
    case $check in
      typecheck) echo "  npm run typecheck" ;;
      lint) echo "  npm run lint" ;;
      tests) echo "  npm run test:ci" ;;
      audit) echo "  npm audit" ;;
    esac
  done
  echo ""
  echo "Use 'git push --no-verify' to skip checks (not recommended)"
  exit 1
fi

echo "‚úÖ All pre-push checks passed!"
